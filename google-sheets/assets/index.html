<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get started with your Twilio Functions!</title>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
    <link rel="stylesheet" href="https://unpkg.com/normalize.css/normalize.css">
    <link rel="stylesheet" href="https://unpkg.com/milligram/dist/milligram.min.css">
    <style>
      body {
        padding: 20px;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      div[role="main"] {
        flex: 1;
      }

      footer {
        text-align: center;
      }

      footer p {
        margin-bottom: 0;
      }

      #twilio-logo {
        width: 50px;
        height: 50px;
      }

      #check-status {
        padding: 1em;
      }

      .status-success {
        color: darkgreen;
      }

      .status-failure {
        color: maroon;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Welcome to your new Twilio App</h1>
    </header>
    <div role="main">
      <section>
        <h3>Get started with your app</h3>
        <p>This app automatically logs texts to your phone number into the specified Google Sheets document. Follow the steps below to test your app:</p>
        <ol>
          <li>Share your Google Sheets document with the email address of your Google Sheets service account.</li>
          <li>Text your Twilio phone number with a message.</li>
          <li>Your spreadsheet should now contain the SID, phone number, and content of the text you sent.</li>
        </ol>
      </section>
      <section>
        <h3>Troubleshooting</h3>
        <ul>
          <li>
            Verify your Google Sheets configuration:
            <div id="check-status">
              <button onclick="showGoogleSheetsStatus()">Verify Configuration</button>
              <span id="status-message"></span>
            </div>
            If the above check reveals problems, edit this function's <code>.env</code> file via the <code>Edit This Code</code> button below, if available, and ensure that all values are correct.
          </li>
          <li>Check the <a href="https://www.twilio.com/console/phone-numbers/incoming">phone number configuration</a> and make sure the Twilio phone number you want your app has an SMS webhook configured to point at
            <p>
              <pre><code><span class="function-root"></span>/log-sms</code></pre>
            </p>
          </li>
          <li>Ensure that you have created a Google service account, and that <code>SHEETS_CLIENT_EMAIL</code> and <code>SHEETS_PRIVATE_KEY</code> contain the values from the <code>client_email</code> and <code>private_key</code> fields of its JSON key file, respectively.</li>
        </ul>
      </section>
      <!-- APP_INFO -->
    </div>
    <footer>
      <p>
        <a href="https://www.twilio.com/">
          <svg id="twilio-logo" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 60 60">
            <defs>
              <style>
                .cls-1 {
                  fill: #f22f46;
                }
              </style>
            </defs>
            <title>Twilio Logo</title><path class="cls-1" d="M30,15A15,15,0,1,0,45,30,15,15,0,0,0,30,15Zm0,26A11,11,0,1,1,41,30,11,11,0,0,1,30,41Zm6.8-14.7a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,36.8,26.3Zm0,7.4a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,36.8,33.7Zm-7.4,0a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,29.4,33.7Zm0-7.4a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,29.4,26.3Z"/></svg>
        </a>
      </p>
      <p>
        <a href="https://www.twilio.com/code-exchange">Learn about other things you can build with Twilio</a>
      </p>
    </footer>

    <script>
      // This code will replace the content of any <span class="function-root"></span> with the base path of the URL
      const baseUrl = new URL(location.href);
      baseUrl.pathname = baseUrl
        .pathname
        .replace(/\/index\.html$/, '');
      delete baseUrl.hash;
      delete baseUrl.search;
      const fullUrl = baseUrl
        .href
        .substr(0, baseUrl.href.length - 1);
      const functionRoots = document.querySelectorAll('span.function-root');

      functionRoots.forEach(element => {
        element.innerText = fullUrl
      })
    </script>
  </body>
  <script>
   async function showGoogleSheetsStatus() {
       const message = document.getElementById('status-message');

       message.className = '';
       message.textContent = 'Checking Google Sheets status...';

       try {
           const res = await fetch('./check-sheets-config', {
               method: 'POST',
           });
           const resData = await res.json();

           message.className = resData.success ? 'status-success' : 'status-failure';
           message.textContent = resData.message;
       } catch (err) {
           message.className = 'status-failure';
           message.textContent = `Google Sheets error: ${err}`;
       }
   }
  </script>
</html>
